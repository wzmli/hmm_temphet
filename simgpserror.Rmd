---
title: "SimGPSerr"
author: "Mike"
date: "December 15, 2016"
output: html_document
---

```{r source and package, include=FALSE}
source("mikesim.R")
library(depmixS4)
library(plyr)
library(dplyr)
library(circular)
library(ggplot2)

```

Simulating 12,000 steps-lengths (without GPS error) and corresponding states. Simple two-state model: S1 is log10norm(0,1) and S2 is log10norm(2,1)
```{r sims}
t <- rep(0:23,500)
y <- rep(1,12000)

tempdat <- data.frame(y=y,t=t)

#set up dummy model and simulate (I am simply using depmix to simulate the WRT the _correct_ transition complexity)
system.time(mod <- depmix(y~1
  , data=tempdat
  , transition=~cos((2*pi*t)/24)+ sin((2*pi*t)/24)
  , nstate=2
  , family=gaussian())
)
getpars(mod)

seed = 1
set.seed(seed)

## randomly selecting mlogit parameters for transition coeffs. 
## 
randpars <- sample(-3:3,length(getpars(mod))-6,replace=TRUE)
newmod <- setpars(mod,c(0.5,0.5,randpars,0,1,2,1))
newmod
sim <- simhmm(newmod)
```

Checkout the step-length histogram and simulate a turning angle WRT the states. S1 is VM(0,0) and S2 is VM(0,10)

```{r turning angle, echo=FALSE,warning=FALSE}
simang <- function(size,mu,ka){
  temp <- rvonmises(size,mu,ka)
  class(temp) <- "numeric"
  return(temp)
}

df <- data.frame(obs= sim@response[[1]][[1]]@y,states=sim@states,time=t)
df2 <- df %>% mutate(angle=ifelse(states==1,simang(1,0,0),simang(1,0,10)))
hist(df$obs)
hist(simang(10000,0,0))
hist(simang(10000,0,10))
```

S2 is long movement with less turns.

Now I am going to transform and add GPS error and back calcuate new step-lengths with gps error

```{r}
xtrans <- function(oldx,r,a){
  oldx + r*cos(a)
}
ytrans <- function(oldy,r,a){
  oldy + r*sin(a)
}
x <- c(0)
y <- c(0)
for(i in 1:nrow(df2)){
  tempx <- xtrans(x[i],10^df2$obs[i],df2$angle[i])
  tempy <- ytrans(y[i],10^df2$obs[i],df2$angle[i])
  newx <- tempx + rnorm(1,0,sqrt(2)*log10(8))
  newy <- tempy + rnorm(1,0,sqrt(2)*log10(8))
  x <- c(x,newx)
  y <- c(y,newy)
}

stepdf <- c()
for(i in 2:length(x)){
  temp <- sqrt((x[i]-x[i-1])^2 + (y[i]-y[i-1])^2)
  stepdf <- c(stepdf,log10(temp))
}

hist(df2$obs,xlab="log(10)")
hist(stepdf,xlab = "log(10)")

```

## Results of 100 simulations

```{r results,echo=FALSE}
ICdat <- readRDS("simxy_results/ICdat.rds")

g1 <- (ggplot(ICdat,aes(x=nstates,y=n,color=model,group=model))
       + geom_point()
       + geom_line()
       + theme_bw()
       + facet_grid(.~IC)
       + ylab("Counts")
       + xlab("Number of States")
       + ggtitle("Simulation Results: Fitting HMMs to Two-State temphet HMM")
) 

g1

```
